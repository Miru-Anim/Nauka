DROP DATABASE IF EXISTS a7x_dyskografia;
CREATE DATABASE a7x_dyskografia;
USE a7x_dyskografia;

CREATE TABLE czlonkowie_zespolu (
    id_czlonek INT AUTO_INCREMENT PRIMARY KEY,
    imie VARCHAR(50),
    nazwisko VARCHAR(50),
    pseudonim VARCHAR(50),
    data_urodzenia DATE,
    kraj_pochodzenia VARCHAR(100)
);

CREATE TABLE instrumenty (
    id_instrument INT AUTO_INCREMENT PRIMARY KEY,
    nazwa VARCHAR(100)
);

CREATE TABLE czlonek_instrument (
    id INT AUTO_INCREMENT PRIMARY KEY,
    czlonek_id INT,
    instrument_id INT,
    data_od DATE,
    data_do DATE,
    FOREIGN KEY (czlonek_id) REFERENCES czlonkowie_zespolu(id_czlonek),
    FOREIGN KEY (instrument_id) REFERENCES instrumenty(id_instrument)
);

CREATE TABLE albumy (
    id_album INT AUTO_INCREMENT PRIMARY KEY,
    tytul_albumu VARCHAR(150) NOT NULL,
    data_wydania DATE,
    wytwornia VARCHAR(100),
    typ_albumu VARCHAR(50),
    czas_trwania TIME
);

CREATE TABLE udzial_w_albumie (
    id_udzial INT AUTO_INCREMENT PRIMARY KEY,
    album_id INT,
    czlonek_id INT,
    rola VARCHAR(100),
    FOREIGN KEY (album_id) REFERENCES albumy(id_album),
    FOREIGN KEY (czlonek_id) REFERENCES czlonkowie_zespolu(id_czlonek)
);

CREATE TABLE utwory (
    id_utwor INT AUTO_INCREMENT PRIMARY KEY,
    album_id INT,
    tytul_utworu VARCHAR(150),
    nr_sciezki INT,
    dlugosc TIME,
    FOREIGN KEY (album_id) REFERENCES albumy(id_album)
);

CREATE TABLE autorzy_utworow (
    id INT AUTO_INCREMENT PRIMARY KEY,
    utwor_id INT,
    czlonek_id INT,
    rola VARCHAR(100),
    FOREIGN KEY (utwor_id) REFERENCES utwory(id_utwor),
    FOREIGN KEY (czlonek_id) REFERENCES czlonkowie_zespolu(id_czlonek)
);

CREATE TABLE producenci (
    id_producent INT AUTO_INCREMENT PRIMARY KEY,
    imie VARCHAR(50),
    nazwisko VARCHAR(50),
    pseudonim VARCHAR(50)
);

CREATE TABLE album_producent (
    id INT AUTO_INCREMENT PRIMARY KEY,
    album_id INT,
    producent_id INT,
    FOREIGN KEY (album_id) REFERENCES albumy(id_album),
    FOREIGN KEY (producent_id) REFERENCES producenci(id_producent)
);

CREATE TABLE gatunki (
    id_gatunek INT AUTO_INCREMENT PRIMARY KEY,
    nazwa VARCHAR(100)
);

CREATE TABLE album_gatunek (
    id INT AUTO_INCREMENT PRIMARY KEY,
    album_id INT,
    gatunek_id INT,
    FOREIGN KEY (album_id) REFERENCES albumy(id_album),
    FOREIGN KEY (gatunek_id) REFERENCES gatunki(id_gatunek)
);

CREATE TABLE nagrody (
    id_nagroda INT AUTO_INCREMENT PRIMARY KEY,
    nazwa VARCHAR(150),
    organizacja VARCHAR(150)
);

CREATE TABLE album_nagroda (
    id INT AUTO_INCREMENT PRIMARY KEY,
    album_id INT,
    nagroda_id INT,
    rok INT,
    wynik VARCHAR(50), -- wygrana / nominacja
    FOREIGN KEY (album_id) REFERENCES albumy(id_album),
    FOREIGN KEY (nagroda_id) REFERENCES nagrody(id_nagroda)
);

CREATE TABLE trasy_koncertowe (
    id_trasa INT AUTO_INCREMENT PRIMARY KEY,
    nazwa_trasy VARCHAR(150),
    rok_rozpoczecia INT,
    rok_zakonczenia INT
);

CREATE TABLE koncerty (
    id_koncert INT AUTO_INCREMENT PRIMARY KEY,
    trasa_id INT,
    data_koncertu DATE,
    miasto VARCHAR(100),
    kraj VARCHAR(100),
    miejsce VARCHAR(150),
    FOREIGN KEY (trasa_id) REFERENCES trasy_koncertowe(id_trasa)
);

CREATE TABLE goscie (
    id_gosc INT AUTO_INCREMENT PRIMARY KEY,
    imie VARCHAR(50),
    nazwisko VARCHAR(50),
    instrument VARCHAR(100)
);

CREATE TABLE utwor_gosc (
    id INT AUTO_INCREMENT PRIMARY KEY,
    utwor_id INT,
    gosc_id INT,
    FOREIGN KEY (utwor_id) REFERENCES utwory(id_utwor),
    FOREIGN KEY (gosc_id) REFERENCES goscie(id_gosc)
);

CREATE VIEW a7x_pelne_dane AS
SELECT
    -- ALBUM
    a.id_album,
    a.tytul_albumu,
    a.data_wydania,
    a.wytwornia,
    a.typ_albumu,
    a.czas_trwania,

    -- UTWÓR
    u.id_utwor,
    u.tytul_utworu,
    u.nr_sciezki,
    u.dlugosc AS dlugosc_utworu,

    -- CZŁONEK ZESPOŁU
    cz.id_czlonek,
    cz.imie,
    cz.nazwisko,
    cz.pseudonim,
    cz.data_urodzenia,
    cz.kraj_pochodzenia,

    -- ROLA NA ALBUMIE
    ua.rola AS rola_w_albumie,

    -- AUTORSTWO UTWORU
    au.rola AS rola_w_utworze,

    -- INSTRUMENT
    i.nazwa AS instrument,

    -- PRODUCENT
    p.pseudonim AS producent,

    -- GATUNEK
    g.nazwa AS gatunek,

    -- NAGRODY
    n.nazwa AS nagroda,
    n.organizacja,
    an.rok AS rok_nagrody,
    an.wynik,

    -- TRASA KONCERTOWA
    tk.nazwa_trasy,
    tk.rok_rozpoczecia,
    tk.rok_zakonczenia,

    -- KONCERT
    k.data_koncertu,
    k.miasto,
    k.kraj,
    k.miejsce,

    -- GOŚCIE W UTWORACH
    go.imie AS gosc_imie,
    go.nazwisko AS gosc_nazwisko,
    go.instrument AS instrument_goscia

FROM albumy a
LEFT JOIN utwory u ON u.album_id = a.id_album
LEFT JOIN udzial_w_albumie ua ON ua.album_id = a.id_album
LEFT JOIN czlonkowie_zespolu cz ON cz.id_czlonek = ua.czlonek_id
LEFT JOIN autorzy_utworow au ON au.utwor_id = u.id_utwor AND au.czlonek_id = cz.id_czlonek
LEFT JOIN czlonek_instrument ci ON ci.czlonek_id = cz.id_czlonek
LEFT JOIN instrumenty i ON i.id_instrument = ci.instrument_id
LEFT JOIN album_producent ap ON ap.album_id = a.id_album
LEFT JOIN producenci p ON p.id_producent = ap.producent_id
LEFT JOIN album_gatunek ag ON ag.album_id = a.id_album
LEFT JOIN gatunki g ON g.id_gatunek = ag.gatunek_id
LEFT JOIN album_nagroda an ON an.album_id = a.id_album
LEFT JOIN nagrody n ON n.id_nagroda = an.nagroda_id
LEFT JOIN koncerty k ON k.trasa_id IN (SELECT id_trasa FROM trasy_koncertowe tk2 WHERE tk2.id_trasa = k.trasa_id)
LEFT JOIN trasy_koncertowe tk ON tk.id_trasa = k.trasa_id
LEFT JOIN utwor_gosc ug ON ug.utwor_id = u.id_utwor
LEFT JOIN goscie go ON go.id_gosc = ug.gosc_id;